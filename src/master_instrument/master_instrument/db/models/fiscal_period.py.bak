from typing import Optional, TYPE_CHECKING
from datetime import date
from sqlalchemy import Date, Integer, SmallInteger, Boolean, ForeignKey, UniqueConstraint, Index
from sqlalchemy.orm import Mapped, mapped_column, relationship
from .base import Base

if TYPE_CHECKING:
    from .company import Company
    from .fiscal_period_type import FiscalPeriodType


class FiscalPeriod(Base):
    __tablename__ = "fiscal_period"
    __table_args__ = (
        UniqueConstraint(
            "company_id",
            "period_end_date",
            "period_type_id",
            "is_interim",
            name="uq_fiscal_period_company_date_type_interim",
        ),
        Index(
            "idx_fiscal_period_company_year",
            "company_id",
            "fiscal_year",
        ),
        Index(
            "idx_fiscal_period_end_date",
            "period_end_date",
        ),
        Index(
            "idx_fiscal_period_calendar_end_date",
            "calendar_end_date",
        ),
        {"schema": "master"},
    )

    fiscal_period_id: Mapped[int] = mapped_column(primary_key=True)

    # Foreign Keys
    company_id: Mapped[int] = mapped_column(
        ForeignKey("master.company.company_id", ondelete="CASCADE"),
        nullable=False,
    )
    period_type_id: Mapped[int] = mapped_column(
        ForeignKey("master.fiscal_period_type.fiscal_period_type_id"),
        nullable=False,
    )

    # Period Information
    period_end_date: Mapped[date] = mapped_column(Date, nullable=False)
    calendar_end_date: Mapped[Optional[date]] = mapped_column(Date)
    fiscal_year: Mapped[int] = mapped_column(Integer, nullable=False)
    fiscal_month: Mapped[int] = mapped_column(SmallInteger, nullable=False)
    is_hybrid: Mapped[Optional[bool]] = mapped_column(Boolean)
    is_interim: Mapped[Optional[bool]] = mapped_column(Boolean, nullable=False)

    # Relationships
    company: Mapped["Company"] = relationship("Company", back_populates="fiscal_periods")
    period_type: Mapped["FiscalPeriodType"] = relationship("FiscalPeriodType")

    def __repr__(self):
        return (
            f"<FiscalPeriod("
            f"id={self.fiscal_period_id}, "
            f"company_id={self.company_id}, "
            f"period_end={self.period_end_date}, "
            f"FY={self.fiscal_year})>"
        )
