{#
  CTE: Inheritance - Child UPSERT (after parent)
  
  Generates the UPSERT for the child table, using the parent IDs.
  Requires: existing upsert_parent CTE.
  
  Params:
    - inheritance: InheritanceConfig
    - source_cte: CTE source original
    - audit: AuditConfig optionnel
    - mapping: MappingConfig optionnel
#}
{# Calcule les colonnes data (non-PK) du child #}
{%- set child_data_cols = [] %}
{%- for col in inheritance.child_columns %}
{%- if col != inheritance.child_unique_key %}
{%- set _ = child_data_cols.append(col) %}
{%- endif %}
{%- endfor %}
enriched_parent AS (
    SELECT
        up.{{ inheritance.parent_unique_key }},
        src.*
    FROM upsert_parent up
{%- if mapping %}
    JOIN {{ source_cte }} src
      ON src.{{ mapping.source_external_id_column }} = up.{{ mapping.source_external_id_column }}
{%- else %}
    CROSS JOIN {{ source_cte }} src
{%- endif %}
),
upsert_child AS (
    INSERT INTO {{ inheritance.child_table }} (
        {{ inheritance.child_unique_key }},
        {% for col in child_data_cols %}{{ col }}{{ "," if not loop.last else "" }}
        {% endfor %}
        {%- if audit -%}
        {%- if audit.with_created_at -%},created_at{%- endif -%}
        {%- if audit.with_updated_at -%},updated_at{%- endif -%}
        {%- endif -%}
    )
    SELECT
        {{ inheritance.parent_unique_key }},
        {% for col in child_data_cols %}{{ col }}{{ "," if not loop.last else "" }}
        {% endfor %}
        {%- if audit -%}
        {%- if audit.with_created_at -%},CURRENT_TIMESTAMP{%- endif -%}
        {%- if audit.with_updated_at -%},CURRENT_TIMESTAMP{%- endif -%}
        {%- endif -%}
    FROM enriched_parent
    ON CONFLICT ({{ inheritance.child_unique_key }})
{%- if child_data_cols or audit %}
    DO UPDATE SET
        {% for col in child_data_cols %}{{ col }} = EXCLUDED.{{ col }}{{ "," if not loop.last else "" }}
        {% endfor %}
        {%- if audit and audit.with_updated_at -%},updated_at = CURRENT_TIMESTAMP{%- endif %}
    WHERE
{%- for col in child_data_cols %}
        {{ inheritance.child_table.split('.')[-1] }}.{{ col }} IS DISTINCT FROM EXCLUDED.{{ col }}{{ " OR" if not loop.last else "" }}
{%- endfor %}
{%- else %}
    DO NOTHING
{%- endif %}
{%- if mapping %}
{%- set type_col = mapping.source_type_column if mapping.source_type_column else mapping.mapping_type_column -%}
{%- if type_col %}
    RETURNING {{ inheritance.child_unique_key }}, src.{{ mapping.source_external_id_column }}, src.{{ mapping.data_source_column }}, src.{{ type_col }}
{%- else %}
    RETURNING {{ inheritance.child_unique_key }}, src.{{ mapping.source_external_id_column }}, src.{{ mapping.data_source_column }}
{%- endif %}
{%- endif %}
)
