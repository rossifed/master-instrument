# Unit test for corporate action adjustment logic
# Test case: DIAMOND BIOTECHNOLOGY (entity_id: 34344, quote_id: 93480)
# Reverse split on 2025-08-27: cum_adj_factor changes from 0.850327892749955 to 1.0
# Focus on boundary dates around the corporate action

unit_tests:
  - name: test_corpact_adjustment_calculation
    description: |
      Validates corporate action price adjustment logic.
      Tests that adjusted_price = (raw_price * cum_adj_factor) / price_unit for OHLC.
      Uses real data from DIAMOND BIOTECHNOLOGY around reverse split date (2025-08-27).
    model: vw_market_data_corp_adjusted
    given:
      - input: ref('vw_market_data_base')
        rows:
          # After corpact (2025-08-27+): factor = 1.0, prices unchanged
          - {quote_id: 1, trade_date: '2025-09-01', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 49.149994, high: 49.149994, low: 47.899994, close: 49.0, volume: 1000, bid: 49.0, ask: 49.1, vwap: 49.0, loaded_at: '2025-09-01 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-29', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 48.399994, high: 49.25, low: 48.25, close: 49.199997, volume: 1000, bid: 49.0, ask: 49.2, vwap: 49.1, loaded_at: '2025-08-29 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-28', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 48.399994, high: 49.899994, low: 46.0, close: 49.050004, volume: 1000, bid: 49.0, ask: 49.1, vwap: 49.0, loaded_at: '2025-08-28 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-27', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 42.350007, high: 50.100007, low: 42.350007, close: 48.399994, volume: 1000, bid: 48.3, ask: 48.5, vwap: 48.4, loaded_at: '2025-08-27 00:00:00'}
          # Before corpact: factor = 0.850327892749955, prices adjusted
          - {quote_id: 1, trade_date: '2025-08-26', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 49.0, high: 51.699994, low: 49.0, close: 50.899994, volume: 1000, bid: 50.8, ask: 51.0, vwap: 50.9, loaded_at: '2025-08-26 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-25', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 49.899994, high: 50.599994, low: 48.299994, close: 49.899994, volume: 1000, bid: 49.8, ask: 50.0, vwap: 49.9, loaded_at: '2025-08-25 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-22', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 50.3, high: 50.5, low: 49.0, close: 49.899994, volume: 1000, bid: 49.8, ask: 50.0, vwap: 49.9, loaded_at: '2025-08-22 00:00:00'}
          - {quote_id: 1, trade_date: '2025-08-21', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 51.2, high: 51.7, low: 49.9, close: 51.0, volume: 1000, bid: 50.9, ask: 51.1, vwap: 51.0, loaded_at: '2025-08-21 00:00:00'}
          - {quote_id: 1, trade_date: '2025-07-25', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 47.35, high: 52.4, low: 47.1, close: 51.0, volume: 1000, bid: 50.9, ask: 51.1, vwap: 51.0, loaded_at: '2025-07-25 00:00:00'}
          - {quote_id: 1, trade_date: '2025-06-15', instrument_id: 1, instrument_name: 'DIAMOND BIO', entity_id: 1, entity_name: 'DIAMOND BIOTECHNOLOGY', currency_id: 1, currency_code: 'USD', is_primary: true, price_unit: 1.0, open: 60.0, high: 60.5, low: 58.5, close: 59.5, volume: 1000, bid: 59.4, ask: 59.6, vwap: 59.5, loaded_at: '2025-06-15 00:00:00'}
      - input: source('master', 'corpact_adjustment')
        rows:
          - {equity_id: 1, adj_type: 2, adj_date: '1960-01-01', end_adj_date: '2025-08-26', cum_adj_factor: 0.850327892749955}
          - {equity_id: 1, adj_type: 2, adj_date: '2025-08-27', end_adj_date: '3000-01-01', cum_adj_factor: 1.0}
    expect:
      rows:
        # After corpact (factor = 1.0) - OHLC unchanged (exact values from input)
        - {quote_id: 1, trade_date: '2025-09-01', adjusted_open: 49.149994, adjusted_high: 49.149994, adjusted_low: 47.899994, adjusted_close: 49.0}
        - {quote_id: 1, trade_date: '2025-08-29', adjusted_open: 48.399994, adjusted_high: 49.25, adjusted_low: 48.25, adjusted_close: 49.199997}
        - {quote_id: 1, trade_date: '2025-08-28', adjusted_open: 48.399994, adjusted_high: 49.899994, adjusted_low: 46.0, adjusted_close: 49.050004}
        - {quote_id: 1, trade_date: '2025-08-27', adjusted_open: 42.350007, adjusted_high: 50.100007, adjusted_low: 42.350007, adjusted_close: 48.399994}
        # Before corpact (factor = 0.850327892749955) - OHLC adjusted (exact calculated values)
        - {quote_id: 1, trade_date: '2025-08-26', adjusted_open: 41.666066744747795, adjusted_high: 43.96194695320531, adjusted_low: 41.666066744747795, adjusted_close: 43.281684639005356}
        - {quote_id: 1, trade_date: '2025-08-25', adjusted_open: 42.431356746255396, adjusted_high: 43.02658627118037, adjusted_low: 41.07083211785547, adjusted_close: 42.431356746255396}
        - {quote_id: 1, trade_date: '2025-08-22', adjusted_open: 42.77149300532273, adjusted_high: 42.94155858387273, adjusted_low: 41.666066744747795, adjusted_close: 42.431356746255396}
        - {quote_id: 1, trade_date: '2025-08-21', adjusted_open: 43.5367881087977, adjusted_high: 43.961952055172674, adjusted_low: 42.43136184822276, adjusted_close: 43.366722530247706}
        - {quote_id: 1, trade_date: '2025-07-25', adjusted_open: 40.26302572171037, adjusted_high: 44.55718158009764, adjusted_low: 40.05044374852288, adjusted_close: 43.366722530247706}
        - {quote_id: 1, trade_date: '2025-06-15', adjusted_open: 51.0196735649973, adjusted_high: 51.44483751137228, adjusted_low: 49.744181725872366, adjusted_close: 50.594509618622325}
